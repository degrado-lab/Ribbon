<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Queueing Pt. 3: Mixed Submission - Ribbon</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../css/custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Queueing Pt. 3: Mixed Submission";
        var mkdocs_page_input_path = "usage/3_queueing_part_3.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Ribbon
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../cookbook/">Cookbook</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Usage</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../getting_started/">How to use Ribbon</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../1_protein_folding/">A Simple Example: Protein Folding</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2_pipelining/">Let's Get Pipelining</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../3_queueing_part_1/">Queueing Pt. 1: Submitting Jobs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../3_queueing_part_2/">Queueing Pt. 2: Linking Jobs</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Queueing Pt. 3: Mixed Submission</a>
    <ul class="current">
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/ribbon_tasks/ribbon_tasks/">Ribbon Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/runner/">Core Ribbon Task</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/batch/batch/">Batch Processing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/config/">Config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/deserialize_and_run/">Serialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/utils/">Utils</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Under the Hood</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../design/">Design Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contribute/">Contributing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Ribbon</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Usage</li>
      <li class="breadcrumb-item active">Queueing Pt. 3: Mixed Submission</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="queueing-pt-3-mixed-submission">Queueing Pt. 3: Mixed Submission</h1>
<p>As seen in the previous tutorial, we can link together complex sets of jobs using the <code>depends_on</code> flag. In this way, we can submit many interdependent jobs ahead of time. (Code: <a href="https://github.com/degrado-lab/Ribbon/tree/main/examples/example5"><code>/examples/example5</code></a>) </p>
<p>However, it's sometimes useful to run small snippets of python code between jobs, or to have programmatic checks to make sure everything's running smoothly (before we submit thousands of jobs that inevitably fail due to a typo). In these instances, we can use a <em>mixed submission</em> strategy. Rather than submitting all of our <code>Tasks</code> to a scheduler at the start, we can queue a set of jobs, wait for them to finish, and check on or modify the results before submitting further jobs. </p>
<p>In this example, we'll predict sequences using LigandMPNN, but before we fold them with RaptorX-Single, we'll apply mutations to those sequences using a simple python function.</p>
<p>We start by queueing our first job:</p>
<pre><code class="language-python">import ribbon
lmpnn_task = ribbon.LigandMPNN(
    structure_list = ['my_structure.pdb'],
    output_dir = './out/lmpnn',
    num_designs = 5
)
lmpnn_job_id = lmpnn_task.queue(scheduler='SLURM')
</code></pre>
<p>Then we'll use <code>ribbon.wait_for_jobs()</code>, to pause our script until our jobs have completed successfully:</p>
<pre><code class="language-python">ribbon.wait_for_jobs([lmpnn_job_id], queue='SLURM')
</code></pre>
<p>This simple function periodically queries the scheduler, keeping track of the status of our jobs.</p>
<p>After all of our jobs have completed, we apply a small mutation to each using the following script:</p>
<pre><code class="language-python">position = 10
mutation = 'A'

import os
os.mkdir('./out/lmpnn/seqs_split_mutated')
for f in os.listdir('./out/lmpnn/seqs_split'):
    with open(os.path.join('./out/lmpnn/seqs_split', f)) as infile, open(os.path.join('./out/lmpnn/seqs_split_mutated', f), 'w') as outfile:
        for line in infile:
                    outfile.write(line if line.startswith('&gt;') else line[:position-1] + mutation + line[position:])

</code></pre>
<p>You'll likely want at more sophisticated method for mutagenesis - but for a tutorial, this will suffice!</p>
<p>Now, we can fold these mutated structures, as before:</p>
<pre><code class="language-python"># Then, we create and queue a RaptorX Task:
raptorx_task = ribbon.RaptorXSingle(
        fasta_file_or_dir = './out/lmpnn/seqs_split',
        output_dir = './out/raptorx',
)
raptorx_task.queue(
            scheduler='SLURM',
            depends_on = [lmpnn_job_id]
)
</code></pre>
<p>All together, our final script looks like:</p>
<pre><code class="language-python">import ribbon

# First, we create 5 new sequences for this structure:
lmpnn_task = ribbon.LigandMPNN(
    structure_list = ['my_structure.pdb'],
    output_dir = './out/lmpnn',
    num_designs = 5
)

# We'll queue the job, and get the job ID
lmpnn_job_id = lmpnn_task.queue(scheduler='SLURM')

# Wait for it to finish:
ribbon.wait_for_jobs([lmpnn_job_id], scheduler='SLURM')


# For all of our output FASTAs, apply a mutation:
position = 10
mutation = 'A'

import os
os.mkdir('./out/lmpnn/seqs_split_mutated')
for f in os.listdir('./out/lmpnn/seqs_split'):
    with open(os.path.join('./out/lmpnn/seqs_split', f)) as infile, open(os.path.join('./out/lmpnn/seqs_split_mutated', f), 'w') as outfile:
        for line in infile:
                    outfile.write(line if line.startswith('&gt;') else line[:position-1] + mutation + line[position:])


# Then, we create and queue a RaptorX Task:
raptorx_task = ribbon.RaptorXSingle(
        fasta_file_or_dir = './out/lmpnn/seqs_split',
        output_dir = './out/raptorx',
)
raptorx_task.queue(
            scheduler='SLURM'
)
</code></pre>
<p>If we execute this script manually, it will run until the final jobs are queued. However, if this script exits prematurely - for example, if your ssh connection closes, your final jobs may not be queued.</p>
<p>To overcome this limitation, we can submit this script as the <em>primary</em> SLURM job, which queues the LigandMPNN and RaptorX-Single <code>Tasks</code> as <em>secondary</em> jobs. After saving our script, we can create a minimal SLURM submission script called <code>submit.sh</code>:</p>
<pre><code class="language-bash">#!/bin/bash
conda activate ribbon
python mixed_scheduling.py
</code></pre>
<p>And submit our <em>primary</em> job with the SLURM command-line interface:</p>
<pre><code class="language-qsub">sbatch submit.sh
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../3_queueing_part_2/" class="btn btn-neutral float-left" title="Queueing Pt. 2: Linking Jobs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../api/ribbon_tasks/ribbon_tasks/" class="btn btn-neutral float-right" title="Ribbon Tasks">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../3_queueing_part_2/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../api/ribbon_tasks/ribbon_tasks/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
